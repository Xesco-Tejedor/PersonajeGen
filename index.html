<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Character Sheet Creator</title>
    <link rel="icon" href="assets/frankenstein.png" type="image/x-icon">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- JSZip for creating ZIP files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- FileSaver.js for saving files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        /* Custom scrollbar for webkit browsers */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* Light gray background */
        }
        .tab-button {
            transition: all 0.3s ease-in-out;
        }
        .tab-button.active {
            border-color: #3b82f6; /* Blue-500 */
            color: #3b82f6;
            background-color: #eff6ff; /* Blue-50 */
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .art-style-card {
            transition: all 0.3s ease-in-out;
            cursor: pointer;
        }
        .art-style-card.selected {
            border-color: #3b82f6; /* Blue-500 */
            box-shadow: 0 0 0 2px #3b82f6;
            transform: translateY(-2px);
        }
        .form-input, .form-textarea {
            border-radius: 0.375rem; /* rounded-md */
            border: 1px solid #d1d5db; /* gray-300 */
            padding: 0.5rem 0.75rem;
            width: 100%;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .form-input:focus, .form-textarea:focus {
            border-color: #3b82f6; /* Blue-500 */
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4);
            outline: none;
        }
        .btn {
            padding: 0.625rem 1.25rem;
            border-radius: 0.375rem; /* rounded-md */
            font-weight: 500;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .btn-primary {
            background-color: #3b82f6; /* Blue-500 */
            color: white;
        }
        .btn-primary:hover {
            background-color: #2563eb; /* Blue-600 */
        }
        .btn-secondary {
            background-color: #6b7280; /* Gray-500 */
            color: white;
        }
        .btn-secondary:hover {
            background-color: #4b5563; /* Gray-600 */
        }
        .btn-outline {
            background-color: transparent;
            color: #3b82f6; /* Blue-500 */
            border: 1px solid #3b82f6;
        }
        .btn-outline:hover {
            background-color: #eff6ff; /* Blue-50 */
        }
        .section-title {
            font-size: 1.25rem; /* text-xl */
            font-weight: 600; /* font-semibold */
            color: #1f2937; /* gray-800 */
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e5e7eb; /* gray-200 */
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #fff;
            margin: auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
        }
        .modal-close {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            color: #888;
        }
        .modal-close:hover {
            color: #000;
        }
        .thumbnail-container img {
            width: 100px;
            height: 100px;
            object-fit: cover;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
            border: 2px solid transparent;
        }
        .thumbnail-container img:hover {
            border-color: #3b82f6;
        }
        #imagePreviewModal img {
            max-width: 90vw;
            max-height: 80vh;
            border-radius: 8px;
        }
        .loader {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #3b82f6; /* Blue */
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .hidden {
            display: none;
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-slate-100 text-slate-800 p-4 md:p-8">

    <div class="container mx-auto max-w-5xl bg-white p-6 md:p-8 rounded-lg shadow-xl">
        <header class="mb-8 text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-blue-600">Creador de Fichas de Personaje con IA</h1>
            <p class="text-slate-600 mt-2">Define, desarrolla y visualiza tus personajes.</p>
        </header>

        <!-- Tabs Navigation -->
        <div class="mb-6 border-b border-slate-300">
            <nav class="flex flex-wrap -mb-px" aria-label="Tabs">
                <button class="tab-button active text-lg py-3 px-4 md:px-6 border-b-2 font-medium" data-tab="basic">üìÑ Informaci√≥n B√°sica</button>
                <button class="tab-button text-lg py-3 px-4 md:px-6 border-b-2 font-medium" data-tab="appearance">üëÅÔ∏è Apariencia</button>
                <button class="tab-button text-lg py-3 px-4 md:px-6 border-b-2 font-medium" data-tab="personality">üß† Personalidad</button>
            </nav>
        </div>

        <!-- Tab Content -->
        <div id="tab-content">
            <!-- Basic Information Tab -->
            <div id="basic-tab" class="tab-content active space-y-6">
                <div>
                    <label for="charName" class="block text-sm font-medium text-slate-700 mb-1">Nombre del Personaje:</label>
                    <input type="text" id="charName" class="form-input" placeholder="Ej: Arion Valerius">
                </div>
                <div>
                    <label for="charTitle" class="block text-sm font-medium text-slate-700 mb-1">T√≠tulo/Apodo:</label>
                    <input type="text" id="charTitle" class="form-input" placeholder="Ej: El Errante Silencioso">
                </div>
                <div>
                    <label for="charRace" class="block text-sm font-medium text-slate-700 mb-1">Raza/Especie:</label>
                    <input type="text" id="charRace" class="form-input" placeholder="Ej: Humano, Elfo, Constructo">
                </div>
                <div>
                    <label for="charClass" class="block text-sm font-medium text-slate-700 mb-1">Ocupaci√≥n/Clase:</label>
                    <input type="text" id="charClass" class="form-input" placeholder="Ej: Mago, Piloto, Detective">
                </div>
                <div>
                    <label for="charBackground" class="block text-sm font-medium text-slate-700 mb-1">Resumen de la Historia de Fondo:</label>
                    <textarea id="charBackground" rows="4" class="form-textarea" placeholder="Una breve descripci√≥n de su pasado..."></textarea>
                </div>
                <button id="expandStoryBtn" class="btn btn-outline">
                    <span class="loader hidden mr-2"></span>‚ú® Expandir Historia con IA
                </button>

                <div class="mt-8 pt-6 border-t border-slate-200 space-x-0 space-y-3 md:space-x-3 md:space-y-0 flex flex-wrap items-center justify-start">
                    <button id="exportSheetBtn" class="btn btn-secondary w-full md:w-auto">üì§ Exportar Ficha (JSON)</button>
                    <button id="exportZipBtn" class="btn btn-primary w-full md:w-auto">üì¶ Exportar a ZIP</button> <!-- New button -->
                    <button id="importSheetBtn" class="btn btn-secondary w-full md:w-auto">üì• Importar Ficha</button>
                </div>
                <div id="importSection" class="hidden mt-4 space-y-3">
                    <label for="importJson" class="block text-sm font-medium text-slate-700">Pega el contenido JSON de la ficha aqu√≠:</label>
                    <textarea id="importJson" rows="5" class="form-textarea"></textarea>
                    <button id="loadSheetBtn" class="btn btn-primary">Cargar Ficha</button>
                </div>
            </div>

            <!-- Appearance Tab -->
            <div id="appearance-tab" class="tab-content space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="charHeight" class="block text-sm font-medium text-slate-700 mb-1">Altura:</label>
                        <input type="text" id="charHeight" class="form-input" placeholder="Ej: 1.80m">
                    </div>
                    <div>
                        <label for="charWeight" class="block text-sm font-medium text-slate-700 mb-1">Peso/Complexi√≥n:</label>
                        <input type="text" id="charWeight" class="form-input" placeholder="Ej: 75kg, atl√©tico">
                    </div>
                </div>
                <div>
                    <label for="charFeatures" class="block text-sm font-medium text-slate-700 mb-1">Rasgos Distintivos:</label>
                    <textarea id="charFeatures" rows="3" class="form-textarea" placeholder="Cicatrices, tatuajes, ojos de diferente color..."></textarea>
                </div>
                <div>
                    <label for="charClothing" class="block text-sm font-medium text-slate-700 mb-1">Vestimenta T√≠pica:</label>
                    <textarea id="charClothing" rows="3" class="form-textarea" placeholder="Armadura de cuero desgastada, t√∫nica elegante..."></textarea>
                </div>
                <div>
                    <label for="charEquipment" class="block text-sm font-medium text-slate-700 mb-1">Equipamiento/Accesorios:</label>
                    <textarea id="charEquipment" rows="3" class="form-textarea" placeholder="Espada ancestral, kit de herramientas, amuleto misterioso..."></textarea>
                </div>
            </div>

            <!-- Personality Tab -->
            <div id="personality-tab" class="tab-content space-y-6">
                <div>
                    <label for="charTraits" class="block text-sm font-medium text-slate-700 mb-1">Rasgos de Personalidad (separados por coma):</label>
                    <input type="text" id="charTraits" class="form-input" placeholder="Valiente, sarc√°stico, leal, curioso...">
                </div>
                <div>
                    <label for="charIdeals" class="block text-sm font-medium text-slate-700 mb-1">Ideales (separados por coma):</label>
                    <input type="text" id="charIdeals" class="form-input" placeholder="Justicia, Libertad, Conocimiento, Venganza...">
                </div>
                <div>
                    <label for="charFlaws" class="block text-sm font-medium text-slate-700 mb-1">Defectos/Debilidades (separados por coma):</label>
                    <input type="text" id="charFlaws" class="form-input" placeholder="Arrogante, miedo a las alturas, impulsivo...">
                </div>
                <div>
                    <label for="charQuotes" class="block text-sm font-medium text-slate-700 mb-1">Citas Memorables (opcional):</label>
                    <textarea id="charQuotes" rows="3" class="form-textarea" placeholder="&quot;El destino se escribe con acciones, no con palabras.&quot;"></textarea>
                </div>
            </div>
        </div>

        <!-- AI Configuration and Artistic Style -->
        <div class="mt-10 pt-6 border-t border-slate-300">
            <h2 class="section-title">üé® Estilo Art√≠stico y Configuraci√≥n de IA</h2>
            <div class="space-y-6">
                <div>
                    <label for="apiKey" class="block text-sm font-medium text-slate-700 mb-1">Clave API de Google AI (Gemini) (Opcional):</label>
                    <input type="password" id="apiKey" class="form-input" placeholder="Pega tu clave API aqu√≠ si la tienes" value="AIzaSyBqV7GAinY7BE1mxj16_f_mMIP1ADBri9o">
                    <p class="text-xs text-slate-500 mt-1">Si no proporcionas una clave, las funciones de IA podr√≠an tener limitaciones o no funcionar.</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">Selecciona un Estilo Art√≠stico para la Imagen:</label>
                    <div id="artisticStyleSelector" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">
                        <div class="art-style-card selected border-2 border-blue-500 p-3 rounded-lg text-center bg-slate-50 hover:bg-slate-100" data-style="Concept Art">Concept Art</div>
                        <div class="art-style-card border p-3 rounded-lg text-center bg-slate-50 hover:bg-slate-100" data-style="Pixar Animation">Animaci√≥n Pixar</div>
                        <div class="art-style-card border p-3 rounded-lg text-center bg-slate-50 hover:bg-slate-100" data-style="Anime Sketch">Boceto Anime</div>
                        <div class="art-style-card border p-3 rounded-lg text-center bg-slate-50 hover:bg-slate-100" data-style="Photorealistic Portrait">Retrato Fotorrealista</div>
                        <div class="art-style-card border p-3 rounded-lg text-center bg-slate-50 hover:bg-slate-100" data-style="Dark Fantasy Art">Arte Fantas√≠a Oscura</div>
                        <div class="art-style-card border p-3 rounded-lg text-center bg-slate-50 hover:bg-slate-100" data-style="Cyberpunk">Cyberpunk</div>
                        <div class="art-style-card border p-3 rounded-lg text-center bg-slate-50 hover:bg-slate-100" data-style="Watercolor Painting">Pintura Acuarela</div>
                        <div class="art-style-card border p-3 rounded-lg text-center bg-slate-50 hover:bg-slate-100" data-style="Pixel Art">Pixel Art</div>
                    </div>
                    <input type="hidden" id="selectedArtStyle" value="Concept Art">
                </div>
                <div>
                    <label for="negativePrompts" class="block text-sm font-medium text-slate-700 mb-1">Prompts Negativos (opcional, separados por coma):</label>
                    <input type="text" id="negativePrompts" class="form-input" placeholder="Ej: borroso, deformado, mala anatom√≠a">
                    <p class="text-xs text-slate-500 mt-1">Elementos que NO quieres que aparezcan en la imagen.</p>
                </div>
            </div>
        </div>

        <!-- AI Prompt Preview -->
        <div class="mt-10 pt-6 border-t border-slate-300">
            <h2 class="section-title">üìù Vista Previa del Prompt de IA (Base para Imagen)</h2>
            <div id="promptPreview" class="p-4 bg-slate-50 rounded-md border border-slate-200 text-sm text-slate-700 min-h-[100px] whitespace-pre-wrap">
                Actualiza los campos para ver la vista previa del prompt...
            </div>
        </div>

        <!-- Generate Button -->
        <div class="mt-10 pt-6 border-t border-slate-300 text-center">
            <button id="generateSheetBtn" class="btn btn-primary text-lg px-8 py-3">
                <span class="loader hidden mr-2"></span>üîÆ Generar Ficha de Personaje (e Im√°genes)
            </button>
        </div>

        <!-- Generated Images -->
        <div id="generatedImagesSection" class="mt-10 pt-6 border-t border-slate-300 hidden">
            <h2 class="section-title">üñºÔ∏è Im√°genes Generadas</h2>
            <div id="imageThumbnails" class="thumbnail-container flex flex-wrap justify-center gap-4">
                <!-- Thumbnails will be appended here -->
            </div>
            <p id="noImagesMessage" class="text-center text-slate-500 hidden">No se han generado im√°genes a√∫n o la generaci√≥n fall√≥.</p>
        </div>
    </div>

    <!-- Message Modal -->
    <div id="messageModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('messageModal')">&times;</span>
            <h3 id="messageModalTitle" class="text-xl font-semibold mb-3">Mensaje</h3>
            <p id="messageModalText"></p>
            <div class="mt-4 text-right">
                <button class="btn btn-primary" onclick="closeModal('messageModal')">Entendido</button>
            </div>
        </div>
    </div>

    <!-- Image Preview Modal -->
    <div id="imagePreviewModal" class="modal" onclick="closeModal('imagePreviewModal')">
        <div class="modal-content p-2 bg-transparent shadow-none max-w-max max-h-max" onclick="event.stopPropagation();">
               <span class="modal-close text-white bg-black bg-opacity-50 rounded-full p-1 leading-none text-2xl -mr-3 -mt-3" onclick="closeModal('imagePreviewModal')">&times;</span>
            <img id="fullPreviewImage" src="https://placehold.co/600x400/E2E8F0/4A5568?text=Preview" alt="Image Preview" class="rounded-lg">
        </div>
    </div>

    <script>
        // Global variable to store generated image base64 data
        let currentGeneratedImages = [];

        // DOM Elements
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        const apiKeyInput = document.getElementById('apiKey');
        const expandStoryBtn = document.getElementById('expandStoryBtn');
        const generateSheetBtn = document.getElementById('generateSheetBtn');
        const promptPreview = document.getElementById('promptPreview');
        const artisticStyleSelector = document.getElementById('artisticStyleSelector');
        const selectedArtStyleInput = document.getElementById('selectedArtStyle');
        const negativePromptsInput = document.getElementById('negativePrompts');
        const imageThumbnailsContainer = document.getElementById('imageThumbnails');
        const generatedImagesSection = document.getElementById('generatedImagesSection');
        const noImagesMessage = document.getElementById('noImagesMessage');
        
        const exportSheetBtn = document.getElementById('exportSheetBtn');
        const exportZipBtn = document.getElementById('exportZipBtn'); // New button element
        const importSheetBtn = document.getElementById('importSheetBtn');
        const importSection = document.getElementById('importSection');
        const importJsonTextarea = document.getElementById('importJson');
        const loadSheetBtn = document.getElementById('loadSheetBtn');

        // Character data fields
        const charFields = [
            'charName', 'charTitle', 'charRace', 'charClass', 'charBackground',
            'charHeight', 'charWeight', 'charFeatures', 'charClothing', 'charEquipment',
            'charTraits', 'charIdeals', 'charFlaws', 'charQuotes'
        ];
        const charInputElements = {};
        charFields.forEach(id => {
            charInputElements[id] = document.getElementById(id);
            if (charInputElements[id]) {
                charInputElements[id].addEventListener('input', updatePromptPreview);
            }
        });

        // Initial Setup
        document.addEventListener('DOMContentLoaded', () => {
            // Tab functionality
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetTab = button.dataset.tab;
                    tabButtons.forEach(btn => {
                        btn.classList.remove('active', 'border-blue-500', 'text-blue-500', 'bg-blue-50');
                        btn.classList.add('border-transparent', 'hover:text-slate-700', 'hover:border-slate-300');
                    });
                    button.classList.add('active', 'border-blue-500', 'text-blue-500', 'bg-blue-50');
                    button.classList.remove('border-transparent', 'hover:text-slate-700', 'hover:border-slate-300');
                    
                    tabContents.forEach(content => {
                        content.classList.remove('active');
                        if (content.id === `${targetTab}-tab`) {
                            content.classList.add('active');
                        }
                    });
                });
            });

            // Artistic Style Selector
            artisticStyleSelector.addEventListener('click', (e) => {
                if (e.target.classList.contains('art-style-card')) {
                    artisticStyleSelector.querySelectorAll('.art-style-card').forEach(card => {
                        card.classList.remove('selected', 'border-blue-500', 'shadow-md');
                        card.classList.add('border-slate-300');
                    });
                    e.target.classList.add('selected', 'border-blue-500', 'shadow-md');
                    e.target.classList.remove('border-slate-300');
                    selectedArtStyleInput.value = e.target.dataset.style;
                    updatePromptPreview();
                }
            });
            
            // Update prompt preview on negative prompt change
            if (negativePromptsInput) {
                negativePromptsInput.addEventListener('input', updatePromptPreview);
            }

            // Button event listeners
            expandStoryBtn.addEventListener('click', handleExpandStory);
            generateSheetBtn.addEventListener('click', handleGenerateSheet);
            exportSheetBtn.addEventListener('click', handleExportSheet);
            exportZipBtn.addEventListener('click', handleExportZip); // Event listener for new button
            importSheetBtn.addEventListener('click', () => {
                importSection.classList.toggle('hidden');
            });
            loadSheetBtn.addEventListener('click', handleImportSheet);

            updatePromptPreview(); // Initial prompt preview
        });

        // --- Helper Functions ---
        function showModal(modalId, title, message) {
            document.getElementById(modalId + 'Title').textContent = title;
            document.getElementById(modalId + 'Text').textContent = message;
            document.getElementById(modalId).style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function showImagePreviewModal(imageUrl) {
            document.getElementById('fullPreviewImage').src = imageUrl;
            document.getElementById('imagePreviewModal').style.display = 'flex';
        }
        
        function toggleButtonLoader(buttonElement, show) {
            const loader = buttonElement.querySelector('.loader');
            if (loader) {
                loader.classList.toggle('hidden', !show);
            }
            buttonElement.disabled = show;
        }

        // --- Character Data Handling ---
        function getCharacterData() {
            const data = {};
            charFields.forEach(id => {
                if (charInputElements[id]) {
                    data[id] = charInputElements[id].value;
                }
            });
            data.selectedArtStyle = selectedArtStyleInput.value;
            data.negativePrompts = negativePromptsInput.value;
            return data;
        }

        function setCharacterData(data) {
            charFields.forEach(id => {
                if (charInputElements[id] && data[id] !== undefined) {
                    charInputElements[id].value = data[id];
                }
            });
            if (data.selectedArtStyle) {
                selectedArtStyleInput.value = data.selectedArtStyle;
                artisticStyleSelector.querySelectorAll('.art-style-card').forEach(card => {
                    card.classList.remove('selected', 'border-blue-500', 'shadow-md');
                    card.classList.add('border-slate-300');
                    if (card.dataset.style === data.selectedArtStyle) {
                        card.classList.add('selected', 'border-blue-500', 'shadow-md');
                        card.classList.remove('border-slate-300');
                    }
                });
            }
            if (data.negativePrompts) {
                negativePromptsInput.value = data.negativePrompts;
            }
            updatePromptPreview();
            showModal('messageModal', '√âxito', 'Ficha de personaje cargada correctamente.');
        }

        // --- Prompt Preview ---
        function updatePromptPreview() {
            const data = getCharacterData();
            let previewText = `Personaje: ${data.charName || '[Nombre]'}\n`;
            previewText += `T√≠tulo/Apodo: ${data.charTitle || '[T√≠tulo]'}\n`;
            previewText += `Raza/Especie: ${data.charRace || '[Raza]'}\n`;
            previewText += `Ocupaci√≥n/Clase: ${data.charClass || '[Clase]'}\n\n`;
            previewText += `Apariencia:\n`;
            previewText += `  Altura: ${data.charHeight || '[Altura]'}\n`;
            previewText += `  Peso/Complexi√≥n: ${data.charWeight || '[Peso/Complexi√≥n]'}\n`;
            previewText += `  Rasgos Distintivos: ${data.charFeatures || '[Ninguno]'}\n`;
            previewText += `  Vestimenta: ${data.charClothing || '[Ropa T√≠pica]'}\n`;
            previewText += `  Equipamiento: ${data.charEquipment || '[Ninguno]'}\n\n`;
            previewText += `Personalidad:\n`;
            previewText += `  Rasgos: ${data.charTraits || '[Rasgos]'}\n`;
            previewText += `  Ideales: ${data.charIdeals || '[Ideales]'}\n`;
            previewText += `  Defectos: ${data.charFlaws || '[Defectos]'}\n\n`;
            previewText += `Estilo Art√≠stico: ${selectedArtStyleInput.value}\n`;
            if (data.negativePrompts) {
                previewText += `Prompts Negativos: ${data.negativePrompts}\n`;
            }
            promptPreview.textContent = previewText;
        }

        // --- AI API Calls ---
        async function callGeminiTextAPI(promptContent) {
            const userApiKey = apiKeyInput.value.trim();
            const apiKey = userApiKey || "AIzaSyBqV7GAinY7BE1mxj16_f_mMIP1ADBri9o";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{ role: "user", parts: [{ text: promptContent }] }]
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Error en API Gemini Text:', errorData);
                    throw new Error(`Error de API: ${response.status} ${response.statusText}. ${errorData.error?.message || ''}`);
                }
                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    console.error('Respuesta inesperada de API Gemini Text:', result);
                    throw new Error('Respuesta inesperada o vac√≠a de la API de texto.');
                }
            } catch (error) {
                console.error('Error al llamar a Gemini Text API:', error);
                showModal('messageModal', 'Error de IA', `No se pudo generar el texto: ${error.message}. Verifica tu clave API y la consola para m√°s detalles.`);
                return null;
            }
        }

        async function callImagenAPI(promptContent, negativePromptText) {
            const userApiKey = apiKeyInput.value.trim();
            const apiKey = userApiKey || ""; // Use user-provided key or fallback

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;
            
            const payload = {
                instances: [{ prompt: promptContent }],
                parameters: { 
                    sampleCount: 2, // Generate 2 images for variety
                }
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Error en API Imagen:', errorData);
                    throw new Error(`Error de API de imagen: ${response.status} ${response.statusText}. ${errorData.error?.message || ''}`);
                }
                const result = await response.json();
                if (result.predictions && result.predictions.length > 0) {
                    return result.predictions.map(p => p.bytesBase64Encoded);
                } else {
                     console.error('Respuesta inesperada de API Imagen:', result);
                    throw new Error('Respuesta inesperada o vac√≠a de la API de imagen.');
                }
            } catch (error) {
                console.error('Error al llamar a Imagen API:', error);
                showModal('messageModal', 'Error de IA', `No se pudieron generar las im√°genes: ${error.message}. Verifica tu clave API y la consola para m√°s detalles.`);
                return null;
            }
        }

        // --- Event Handlers ---
        async function handleExpandStory() {
            const currentStory = charInputElements.charBackground.value;
            if (!currentStory.trim()) {
                showModal('messageModal', 'Informaci√≥n Requerida', 'Por favor, escribe un resumen de la historia de fondo primero.');
                return;
            }
            
            toggleButtonLoader(expandStoryBtn, true);
            const prompt = `Eres un escritor creativo. Expande la siguiente historia de fondo para un personaje de ficci√≥n. Hazla m√°s detallada e interesante:\n\n"${currentStory}"`;
            const expandedStory = await callGeminiTextAPI(prompt);
            toggleButtonLoader(expandStoryBtn, false);

            if (expandedStory) {
                charInputElements.charBackground.value = expandedStory;
                showModal('messageModal', '√âxito', 'Historia expandida por la IA.');
                updatePromptPreview();
            }
        }

        async function handleGenerateSheet() {
            const data = getCharacterData();
            if (!data.charName || !data.charRace || !data.charClass) {
                showModal('messageModal', 'Informaci√≥n Requerida', 'Por favor, completa al menos Nombre, Raza y Clase del personaje antes de generar im√°genes.');
                return;
            }

            toggleButtonLoader(generateSheetBtn, true);
            generatedImagesSection.classList.remove('hidden');
            imageThumbnailsContainer.innerHTML = '<div class="loader mx-auto my-4"></div><p class="w-full text-center text-slate-500">Generando im√°genes...</p>';
            noImagesMessage.classList.add('hidden');
            currentGeneratedImages = []; // Clear previous images

            const prompt = promptPreview.textContent; // Use the full prompt preview for image generation
            const negativePrompts = negativePromptsInput.value.trim();

            const imagesBase64 = await callImagenAPI(prompt, negativePrompts);
            toggleButtonLoader(generateSheetBtn, false);

            imageThumbnailsContainer.innerHTML = ''; // Clear loader and message
            if (imagesBase64 && imagesBase64.length > 0) {
                currentGeneratedImages = imagesBase64; // Store generated images
                imagesBase64.forEach((base64Data, index) => {
                    const imageUrl = `data:image/png;base64,${base64Data}`;
                    const img = document.createElement('img');
                    img.src = imageUrl;
                    img.alt = `Generated Character Image ${index + 1}`;
                    img.classList.add('hover:scale-105', 'transform', 'transition-transform');
                    img.onclick = () => showImagePreviewModal(imageUrl);
                    imageThumbnailsContainer.appendChild(img);
                });
                showModal('messageModal', '√âxito', 'Im√°genes de personaje generadas correctamente.');
            } else {
                noImagesMessage.classList.remove('hidden');
                showModal('messageModal', 'Error', 'No se pudieron generar im√°genes. Int√©ntalo de nuevo o ajusta los par√°metros.');
            }
        }

        function handleExportSheet() {
            const data = getCharacterData();
            const filename = `${data.charName || 'personaje'}_ficha.json`;
            const jsonString = JSON.stringify(data, null, 2);
            
            const blob = new Blob([jsonString], { type: 'application/json' });
            saveAs(blob, filename);
            showModal('messageModal', 'Exportar Ficha', `Ficha de personaje exportada como "${filename}".`);
        }

        async function handleExportZip() {
            const data = getCharacterData();
            const charName = data.charName || 'personaje_desconocido';
            const zip = new JSZip();

            // 1. Add Markdown file
            let markdownContent = `# Ficha de Personaje: ${data.charName || 'Sin Nombre'}\n\n`;
            markdownContent += `## Informaci√≥n B√°sica\n`;
            markdownContent += `- **Nombre:** ${data.charName || 'N/A'}\n`;
            markdownContent += `- **T√≠tulo/Apodo:** ${data.charTitle || 'N/A'}\n`;
            markdownContent += `- **Raza/Especie:** ${data.charRace || 'N/A'}\n`;
            markdownContent += `- **Ocupaci√≥n/Clase:** ${data.charClass || 'N/A'}\n`;
            markdownContent += `- **Historia de Fondo:**\n${data.charBackground ? data.charBackground.split('\n').map(line => `  ${line}`).join('\n') : '  N/A'}\n\n`;

            markdownContent += `## Apariencia\n`;
            markdownContent += `- **Altura:** ${data.charHeight || 'N/A'}\n`;
            markdownContent += `- **Peso/Complexi√≥n:** ${data.charWeight || 'N/A'}\n`;
            markdownContent += `- **Rasgos Distintivos:** ${data.charFeatures || 'N/A'}\n`;
            markdownContent += `- **Vestimenta T√≠pica:** ${data.charClothing || 'N/A'}\n`;
            markdownContent += `- **Equipamiento/Accesorios:** ${data.charEquipment || 'N/A'}\n\n`;

            markdownContent += `## Personalidad\n`;
            markdownContent += `- **Rasgos de Personalidad:** ${data.charTraits || 'N/A'}\n`;
            markdownContent += `- **Ideales:** ${data.charIdeals || 'N/A'}\n`;
            markdownContent += `- **Defectos/Debilidades:** ${data.charFlaws || 'N/A'}\n`;
            markdownContent += `- **Citas Memorables:**\n${data.charQuotes ? data.charQuotes.split('\n').map(line => `  "${line}"`).join('\n') : '  N/A'}\n\n`;

            markdownContent += `## Configuraci√≥n de IA Utilizada\n`;
            markdownContent += `- **Estilo Art√≠stico Seleccionado:** ${data.selectedArtStyle || 'N/A'}\n`;
            markdownContent += `- **Prompts Negativos:** ${data.negativePrompts || 'N/A'}\n`;

            zip.file(`${charName}_ficha.md`, markdownContent);

            // 2. Add Images
            if (currentGeneratedImages.length > 0) {
                currentGeneratedImages.forEach((base64Data, index) => {
                    // Remove the "data:image/png;base64," prefix
                    const base64ImageContent = base64Data.split(',')[1];
                    zip.file(`${charName}_imagen_${index + 1}.png`, base64ImageContent, { base64: true });
                });
            } else {
                showModal('messageModal', 'Advertencia', 'No hay im√°genes generadas para exportar en el ZIP. Solo se exportar√° la ficha.');
            }

            // 3. Generate and download the ZIP file
            toggleButtonLoader(exportZipBtn, true);
            try {
                const content = await zip.generateAsync({ type: "blob" });
                saveAs(content, `${charName}_datos.zip`);
                showModal('messageModal', 'Exportar a ZIP', `Datos del personaje exportados como "${charName}_datos.zip".`);
            } catch (error) {
                console.error('Error al generar el archivo ZIP:', error);
                showModal('messageModal', 'Error', `No se pudo generar el archivo ZIP: ${error.message}.`);
            } finally {
                toggleButtonLoader(exportZipBtn, false);
            }
        }

        function handleImportSheet() {
            try {
                const jsonString = importJsonTextarea.value;
                const importedData = JSON.parse(jsonString);
                setCharacterData(importedData);
                importSection.classList.add('hidden'); // Hide import section after loading
            } catch (error) {
                showModal('messageModal', 'Error de Importaci√≥n', `Error al parsear el JSON: ${error.message}. Aseg√∫rate de que el formato sea correcto.`);
                console.error('Error importing sheet:', error);
            }
        }
    </script>
</body>
</html>
